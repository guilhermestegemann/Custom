SET TERM ^ ;

CREATE OR ALTER trigger pe_in for pedido
active before update position 10
AS
/*Configuracao*/
DECLARE VARIABLE VGERARMOVIMENTO VARCHAR(1);
DECLARE VARIABLE VGERARESTOQUE VARCHAR(1);
DECLARE VARIABLE VGERARESTOQUEIMPROPRIO VARCHAR(1);
DECLARE VARIABLE VGERARCONSUMO VARCHAR(1);
DECLARE VARIABLE VGERARBONIFICACAO VARCHAR(1);
DECLARE VARIABLE VGERARTROCA VARCHAR(1);
DECLARE VARIABLE VGERARFINANCEIRO VARCHAR(1);
DECLARE VARIABLE VTIPOCFOP INTEGER;
DECLARE VARIABLE VORDEM VARCHAR(15);
DECLARE VARIABLE VCAIXA INTEGER;
DECLARE VARIABLE VPRODUTO INTEGER;
DECLARE VARIABLE VQUANTIDADE NUMERIC(8,3);
DECLARE VARIABLE VREGISTRO INTEGER;
DECLARE VARIABLE VBLOQUEARCANCELAR VARCHAR(1);
DECLARE VARIABLE VCONTROLALOTEVALIDADE VARCHAR(1);
DECLARE VARIABLE VCONTROLARLOTEVALIDADE VARCHAR(1);
DECLARE VARIABLE VLOTE VARCHAR(15);
DECLARE VARIABLE VVALIDADE DATE;
DECLARE VARIABLE VQTDE NUMERIC(8,3);
DECLARE VARIABLE VFABRICACAO DATE;
BEGIN
    IF (NEW.CANCELADO <> OLD.CANCELADO) THEN BEGIN
       IF ((NEW.ATUALIZADO = 'S') AND (NEW.CANCELADO = 'S')) THEN BEGIN
          SELECT FILIAL.BLOQUEARCANCELARBAIXADO, FILIAL.CONTROLALOTEVALIDADE FROM FILIAL
          WHERE FILIAL.CODIGO = NEW.FILIAL
          INTO :VBLOQUEARCANCELAR, :VCONTROLALOTEVALIDADE;
          IF (:VBLOQUEARCANCELAR = 'S') THEN BEGIN
             SELECT COUNT(*) FROM FINANCEIRO
             WHERE FINANCEIRO.CLIFOR = NEW.CLIFOR
             AND FINANCEIRO.FILIAL = NEW.FILIAL
             AND FINANCEIRO.DATABAIXA IS NOT NULL
             AND FINANCEIRO.ORDEM IN (SELECT ORDEMPEDIDO.ORDEM FROM ORDEMPEDIDO
             WHERE ORDEMPEDIDO.NUMERO = NEW.NUMERO AND ORDEMPEDIDO.FILIAL = NEW.FILIAL)
             INTO :VREGISTRO;
             IF (:VREGISTRO > 0) THEN
                EXCEPTION EXCEPTION_CANCELARBAIXADO;
          END
          NEW.ATUALIZADO = 'N';
          /*Tipo de pedido*/
          SELECT TIPOPEDIDO.GERARMOVIMENTO, TIPOPEDIDO.TIPOCFOP
          FROM TIPOPEDIDO WHERE TIPOPEDIDO.CODIGO = NEW.TIPOPEDIDO
          INTO :VGERARMOVIMENTO, :VTIPOCFOP;
          IF (:VGERARMOVIMENTO = 'S') THEN BEGIN
             /*Tipo de CFOP*/
             SELECT TIPOCFOP.GERARESTOQUE, TIPOCFOP.GERARCONSUMO, TIPOCFOP.GERARTROCA, TIPOCFOP.GERARFINANCEIRO, TIPOCFOP.GERARBONIFICACAO, TIPOCFOP.GERARESTOQUEIMPROPRIO
             FROM TIPOCFOP WHERE (TIPOCFOP.CODIGO = :VTIPOCFOP)
             INTO :VGERARESTOQUE,:VGERARCONSUMO,:VGERARTROCA,:VGERARFINANCEIRO,:VGERARBONIFICACAO, :VGERARESTOQUEIMPROPRIO;
             IF (:VGERARTROCA = 'S') THEN BEGIN
                 DELETE FROM TROCA
                 WHERE TROCA.FILIAL = NEW.FILIAL AND TROCA.TIPO = 'PE'
                 AND TROCA.DOCUMENTO = NEW.NUMERO AND TROCA.CLIFOR = NEW.CLIFOR;
             END
             IF (:VGERARBONIFICACAO = 'S') THEN BEGIN
                 DELETE FROM BONIFICACAO
                 WHERE BONIFICACAO.FILIAL = NEW.FILIAL AND BONIFICACAO.TIPO = 'PE'
                 AND BONIFICACAO.DOCUMENTO = NEW.NUMERO AND BONIFICACAO.CLIFOR = NEW.CLIFOR;
             END
             IF (:VGERARCONSUMO = 'S') THEN BEGIN
                DELETE FROM CONSUMO
                WHERE CONSUMO.FILIAL = NEW.FILIAL AND CONSUMO.TIPO = 'PE'
                AND CONSUMO.DOCUMENTO = NEW.NUMERO AND CONSUMO.CLIFOR = NEW.CLIFOR;
             END
             IF (:VGERARESTOQUE = 'S') THEN BEGIN
                FOR
                   SELECT ITEMPEDIDO.PRODUTO, (ITEMPEDIDO.QTDE - ITEMPEDIDO.QTDEDEVOLVIDO)
                   FROM ITEMPEDIDO
                   WHERE ITEMPEDIDO.NUMERO = NEW.NUMERO AND ITEMPEDIDO.FILIAL = NEW.FILIAL
                   INTO :VPRODUTO, :VQUANTIDADE
                DO BEGIN
                   IF (:VCONTROLALOTEVALIDADE = 'S') THEN BEGIN
                       SELECT ESTOQUE.CONTROLARLOTEVALIDADE FROM ESTOQUE
                       WHERE ESTOQUE.PRODUTO = :VPRODUTO
                       AND ESTOQUE.FILIAL = NEW.FILIAL
                       INTO :VCONTROLARLOTEVALIDADE;
                       IF (:VCONTROLARLOTEVALIDADE = 'S') THEN BEGIN
                           FOR
                               SELECT VALIDADEITEMPEDIDO.LOTE, VALIDADEITEMPEDIDO.VALIDADE, VALIDADEITEMPEDIDO.QTDE, VALIDADEITEMPEDIDO.FABRICACAO
                               FROM VALIDADEITEMPEDIDO
                               WHERE VALIDADEITEMPEDIDO.NUMERO = NEW.NUMERO
                               AND VALIDADEITEMPEDIDO.FILIAL = NEW.FILIAL
                               AND VALIDADEITEMPEDIDO.PRODUTO = :VPRODUTO
                               INTO :VLOTE, :VVALIDADE, :VQTDE, :VFABRICACAO
                           DO BEGIN
                              INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,               MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO)
                                                    VALUES(NEW.FILIAL,              :VPRODUTO,              :VQTDE,              :VLOTE,              :VVALIDADE,              'C-PE',                'PEDIDO CANCELAMENTO:'||NEW.NUMERO, :VFABRICACAO, :VGERARESTOQUEIMPROPRIO);
                           END
                           DELETE FROM VALIDADEITEMPEDIDO
                           WHERE VALIDADEITEMPEDIDO.NUMERO = NEW.NUMERO
                           AND VALIDADEITEMPEDIDO.FILIAL = NEW.FILIAL
                           AND VALIDADEITEMPEDIDO.PRODUTO = :VPRODUTO;
                       END ELSE BEGIN
                            INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS, MOVIMENTOESTOQUE.IMPROPRIO)
                                                  VALUES(NEW.FILIAL,              :VPRODUTO,              :VQUANTIDADE,        'C-PE',                'PEDIDO CANCELAMENTO:'||NEW.NUMERO, :VGERARESTOQUEIMPROPRIO);
                       END
                   END ELSE BEGIN
                       INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS, MOVIMENTOESTOQUE.IMPROPRIO)
                                             VALUES(NEW.FILIAL,              :VPRODUTO,              :VQUANTIDADE,        'C-PE',                'PEDIDO CANCELAMENTO:'||NEW.NUMERO, :VGERARESTOQUEIMPROPRIO);
                   END
                END
             END
             IF (:VGERARFINANCEIRO = 'S') THEN BEGIN
                FOR
                   SELECT ORDEMPEDIDO.ORDEM FROM ORDEMPEDIDO
                   WHERE ORDEMPEDIDO.NUMERO = NEW.NUMERO AND ORDEMPEDIDO.FILIAL = NEW.FILIAL
                   INTO :VORDEM
                DO BEGIN
                    SELECT FINANCEIRO.CAIXA FROM FINANCEIRO
                    WHERE FINANCEIRO.ORDEM = :VORDEM
                    AND FINANCEIRO.CLIFOR = NEW.CLIFOR
                    AND FINANCEIRO.DATAEMISSAO = NEW.EMISSAO
                    INTO :VCAIXA;
                    IF (:VCAIXA > 0) THEN BEGIN
                       UPDATE FINANCEIRO SET FINANCEIRO.CAIXA = NULL
                       WHERE FINANCEIRO.ORDEM = :VORDEM
                       AND FINANCEIRO.CLIFOR = NEW.CLIFOR
                       AND FINANCEIRO.DATAEMISSAO = NEW.EMISSAO;
                       DELETE FROM CAIXA
                       WHERE CAIXA.CODIGO = :VCAIXA;
                    END
                    DELETE FROM FINANCEIRO
                    WHERE FINANCEIRO.ORDEM = :VORDEM
                    AND FINANCEIRO.CLIFOR = NEW.CLIFOR
                    AND FINANCEIRO.DATAEMISSAO = NEW.EMISSAO;
                END
             END
          END
       END
    END
END
^

SET TERM ; ^