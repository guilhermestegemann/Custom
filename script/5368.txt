--LISTA ABERTOS
SELECT
    LIST(ROMANEIO.CODIGO, ', ') AS ROMANEIOS
FROM ROMANEIO
WHERE ROMANEIO.DATA BETWEEN :DATAINICIO AND :DATAFIM
AND ROMANEIO.FILIAL = :FILIAL
AND ROMANEIO.FECHADO = 'N'


--LISTA FECHADOS
SELECT
    'FECHADO' AS STATUS,
    LIST(ROMANEIO.CODIGO, ', ')
FROM ROMANEIO
WHERE ROMANEIO.DATAFECHAMENTO BETWEEN :DATAINICIO AND :DATAFIM
AND ROMANEIO.FILIAL = :FILIAL
AND ROMANEIO.FECHADO = 'S'
GROUP BY 1

--TOTAL FATURADO
SELECT
CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.FORMAPAGAMENTO ELSE NF.FORMAPAGAMENTO END AS FORMAPAGAMENTO
,FORMAPAGAMENTO.NOME AS NOMEFORMAPAGAMENTO
,SUM( CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.TOTAL ELSE CASE WHEN NFP.TOTAL IS NOT NULL THEN NFP.TOTAL ELSE NF.TOTAL END END) AS TOTAL
FROM ROMANEIO
INNER JOIN ITEMROMANEIO ON ITEMROMANEIO.ROMANEIO = ROMANEIO.CODIGO
LEFT JOIN PEDIDO ON ITEMROMANEIO.TIPO = 'P' AND PEDIDO.NUMERO = ITEMROMANEIO.NUMERO AND PEDIDO.FILIAL = ROMANEIO.FILIAL
LEFT JOIN NF ON ITEMROMANEIO.TIPO = 'N' AND NF.NUMERO = ITEMROMANEIO.NUMERO AND NF.SERIE = ITEMROMANEIO.SERIE AND NF.FILIAL = ROMANEIO.FILIAL AND NF.ORIGEM = 'P'
LEFT JOIN NF NFP ON ITEMROMANEIO.TIPO = 'P' AND NFP.PEDIDO = ITEMROMANEIO.NUMERO AND NFP.FILIAL = ROMANEIO.FILIAL AND NFP.ORIGEM = 'P' AND NFP.CLIFOR = PEDIDO.CLIFOR AND NFP.CANCELADA = 'N'
LEFT JOIN TIPOCFOP ON ((ITEMROMANEIO.TIPO = 'P' AND TIPOCFOP.CODIGO = NFP.TIPOCFOP) OR (ITEMROMANEIO.TIPO = 'N' AND TIPOCFOP.CODIGO = NF.TIPOCFOP))
LEFT JOIN FORMAPAGAMENTO ON FORMAPAGAMENTO.CODIGO = CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.FORMAPAGAMENTO ELSE NF.FORMAPAGAMENTO END
WHERE ((TIPOCFOP.FATURA = 'S') OR (TIPOCFOP.FATURA IS NULL))
AND ROMANEIO.DATA BETWEEN '15.01.2019' AND '12.04.2019'
AND ROMANEIO.CODIGO = 66406
AND ROMANEIO.FECHADO = 'S'
GROUP BY 1,2

--TOTAL RECEBIDO
SELECT FINANCEIRO.FORMAPAGAMENTO, FORMAPAGAMENTO.NOME,  SUM(CAIXA.VALOR) FROM CAIXA
INNER JOIN FINANCEIRO ON FINANCEIRO.CAIXA = CAIXA.CODIGO
LEFT JOIN FORMAPAGAMENTO ON FINANCEIRO.FORMAPAGAMENTO = FORMAPAGAMENTO.CODIGO
WHERE CAIXA.ROMANEIO = 66850 AND DATA > '01.01.2019'
GROUP BY 1,2


           		





--juncao calculando diferenca
SELECT
    R1.*
    --, (VALORTOTALRECEBIDO - VALORTOTALFATURADO - VALORTOTALCANCELADO - VALORTOTALDEVOLVIDO) AS DIFERENCA
FROM
(
    WITH
        TMPFATURADO AS
        (
            SELECT
                CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.FORMAPAGAMENTO ELSE NF.FORMAPAGAMENTO END AS FORMAPAGAMENTO
				, FORMAPAGAMENTO.NOME AS NOMEFORMAPAGAMENTO
                , SUM( CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.TOTAL ELSE CASE WHEN NFP.TOTAL IS NOT NULL THEN NFP.TOTAL ELSE NF.TOTAL END END) AS TOTALFATURADO
            FROM ROMANEIO
            INNER JOIN ITEMROMANEIO ON ITEMROMANEIO.ROMANEIO = ROMANEIO.CODIGO
            LEFT JOIN PEDIDO ON ITEMROMANEIO.TIPO = 'P' AND PEDIDO.NUMERO = ITEMROMANEIO.NUMERO AND PEDIDO.FILIAL = ROMANEIO.FILIAL
            LEFT JOIN NF ON ITEMROMANEIO.TIPO = 'N' AND NF.NUMERO = ITEMROMANEIO.NUMERO AND NF.SERIE = ITEMROMANEIO.SERIE AND NF.FILIAL = ROMANEIO.FILIAL AND NF.ORIGEM = 'P'
            LEFT JOIN NF NFP ON ITEMROMANEIO.TIPO = 'P' AND NFP.PEDIDO = ITEMROMANEIO.NUMERO AND NFP.FILIAL = ROMANEIO.FILIAL AND NFP.ORIGEM = 'P' AND NFP.CLIFOR = PEDIDO.CLIFOR
            LEFT JOIN TIPOCFOP ON ((ITEMROMANEIO.TIPO = 'P' AND TIPOCFOP.CODIGO = NFP.TIPOCFOP) OR (ITEMROMANEIO.TIPO = 'N' AND TIPOCFOP.CODIGO = NF.TIPOCFOP))
            LEFT JOIN FORMAPAGAMENTO ON FORMAPAGAMENTO.CODIGO = CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.FORMAPAGAMENTO ELSE NF.FORMAPAGAMENTO END
            WHERE ((TIPOCFOP.FATURA = 'S') OR (TIPOCFOP.FATURA IS NULL))
            AND ROMANEIO.DATA BETWEEN :datainicio AND :datafim
            AND ROMANEIO.CODIGO = :romaneio
            AND ROMANEIO.FECHADO = :FECHADO
            GROUP BY 1
        ),
        TMPCANCELADO AS
        (
            SELECT
                CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.FORMAPAGAMENTO ELSE NF.FORMAPAGAMENTO END AS FORMAPAGAMENTO
                ,SUM( CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.TOTAL ELSE CASE WHEN NFP.TOTAL IS NOT NULL THEN NFP.TOTAL ELSE NF.TOTAL END END) AS TOTALCANCELADO
            FROM ROMANEIO
            INNER JOIN ITEMROMANEIO ON ITEMROMANEIO.ROMANEIO = ROMANEIO.CODIGO
            LEFT JOIN PEDIDO ON ITEMROMANEIO.TIPO = 'P' AND PEDIDO.NUMERO = ITEMROMANEIO.NUMERO AND PEDIDO.FILIAL = ROMANEIO.FILIAL AND PEDIDO.CANCELADO = 'S' AND PEDIDO.TOTALDEVOLVIDO = 0 -- Cancelado, nao devolvido
            LEFT JOIN NF ON ITEMROMANEIO.TIPO = 'N' AND NF.NUMERO = ITEMROMANEIO.NUMERO AND NF.SERIE = ITEMROMANEIO.SERIE AND NF.FILIAL = ROMANEIO.FILIAL AND NF.ORIGEM = 'P' AND NF.CANCELADA = 'S' AND NF.DEVOLVIDA = 'N'
            LEFT JOIN NF NFP ON ITEMROMANEIO.TIPO = 'P' AND NFP.PEDIDO = ITEMROMANEIO.NUMERO AND NFP.FILIAL = ROMANEIO.FILIAL AND NFP.ORIGEM = 'P' AND NFP.CLIFOR = PEDIDO.CLIFOR AND NFP.CANCELADA = 'S' AND NFP.DEVOLVIDA = 'N'
            LEFT JOIN TIPOCFOP ON ((ITEMROMANEIO.TIPO = 'P' AND TIPOCFOP.CODIGO = NFP.TIPOCFOP) OR (ITEMROMANEIO.TIPO = 'N' AND TIPOCFOP.CODIGO = NF.TIPOCFOP))
            LEFT JOIN FORMAPAGAMENTO ON FORMAPAGAMENTO.CODIGO = CASE WHEN(ITEMROMANEIO.TIPO = 'P') THEN PEDIDO.FORMAPAGAMENTO ELSE NF.FORMAPAGAMENTO END
            WHERE ((TIPOCFOP.FATURA = 'S') OR (TIPOCFOP.FATURA IS NULL))
            AND ROMANEIO.DATA BETWEEN :datainicio AND :datafim
            AND ROMANEIO.CODIGO = :romaneio
            AND ROMANEIO.FECHADO = :FECHADO
            GROUP BY 1
        ),
       /* TMPDEVOLVIDO AS
        (
            SELECT
                PEDIDO.FORMAPAGAMENTO AS FORMAPAGAMENTO
				, FORMAPAGAMENTO.NOME AS NOMEFORMAPAGAMENTO
                , SUM((ITEMPEDIDO.TOTAL/ITEMPEDIDO.QTDE)*(ITEMPEDIDO.QTDEDEVOLVIDO)) AS TOTALDEVOLVIDO
            FROM ITEMROMANEIO
            INNER JOIN ITEMPEDIDO ON ITEMPEDIDO.NUMERO = ITEMROMANEIO.NUMERO
            INNER JOIN PEDIDO ON PEDIDO.ID = ITEMPEDIDO.IDPEDIDO
            INNER JOIN PRODUTO ON PRODUTO.CODIGO = ITEMPEDIDO.PRODUTO 
            INNER JOIN ROMANEIO ON ROMANEIO.CODIGO = ITEMROMANEIO.ROMANEIO 
            WHERE ITEMROMANEIO.TIPO = 'P' AND ITEMPEDIDO.QTDEDEVOLVIDO > 0 AND ITEMPEDIDO.FILIAL = ROMANEIO.FILIAL 
            AND ROMANEIO.DATA BETWEEN :DATAINICIO AND :DATAFIM
                    AND ROMANEIO.CODIGO = :ROMANEIO
                    AND ROMANEIO.FECHADO = :FECHADO
            GROUP BY 1,2
            UNION
            SELECT
                NF.FORMAPAGAMENTO AS FORMAPAGAMENTO
				, FORMAPAGAMENTO.NOME AS NOMEFORMAPAGAMENTO
                , SUM((ITEMNF.TOTAL/ITEMNF.QTDE)*(ITEMNF.QTDEDEVOLVIDO)) AS TOTALDEVOLVIDO
            FROM ITEMROMANEIO 
            INNER JOIN ITEMNF ON ITEMNF.NUMERO = ITEMROMANEIO.NUMERO
            INNER JOIN NF ON NF.ID = ITEMNF.IDNF
            INNER JOIN PRODUTO ON PRODUTO.CODIGO = ITEMNF.PRODUTO 
            INNER JOIN ROMANEIO ON ROMANEIO.CODIGO = ITEMROMANEIO.ROMANEIO 
            WHERE ITEMROMANEIO.TIPO = 'N' AND ITEMNF.QTDEDEVOLVIDO > 0 AND ITEMNF.FILIAL = ROMANEIO.FILIAL
            AND ROMANEIO.DATA BETWEEN :DATAINICIO AND :DATAFIM
                        AND ROMANEIO.CODIGO = :ROMANEIO
                        AND ROMANEIO.FECHADO = :FECHADO
            GROUP BY 1,2
        ), */
        TMPRECEBIDO AS
        (
            SELECT FINANCEIRO.FORMAPAGAMENTO AS FORMAPAGAMENTO
			    , FORMAPAGAMENTO.NOME AS NOMEFORMAPAGAMENTO
                , SUM(CAIXA.VALOR) AS TOTALRECEBIDO
            FROM CAIXA
            INNER JOIN FINANCEIRO ON FINANCEIRO.CAIXA = CAIXA.CODIGO
            LEFT JOIN FORMAPAGAMENTO ON FINANCEIRO.FORMAPAGAMENTO = FORMAPAGAMENTO.CODIGO
			INNER JOIN ROMANEIO ON ROMANEIO.CODIGO = CAIXA.ROMANEIO
            !CONDICAO
            GROUP BY 1
        )
        SELECT
            FORMAPAGAMENTO.CODIGO AS FORMAPAGAMENTO
            , FORMAPAGAMENTO.NOME AS NOMEFORMAPAGAMENTO
            , SUM(COALESCE(TMPFATURADO.TOTALFATURADO,0)) AS VALORTOTALFATURADO
            , SUM(COALESCE(TMPCANCELADO.TOTALCANCELADO,0)) AS VALORTOTALCANCELADO
            --, SUM(COALESCE(TMPDEVOLVIDO.TOTALDEVOLVIDO,0)) AS VALORTOTALDEVOLVIDO
            , SUM(COALESCE(TMPRECEBIDO.TOTALRECEBIDO,0)) AS VALORTOTALRECEBIDO

        FROM
        FORMAPAGAMENTO
        LEFT JOIN TMPFATURADO ON TMPFATURADO.FORMAPAGAMENTO = FORMAPAGAMENTO.CODIGO
        LEFT JOIN TMPRECEBIDO ON TMPRECEBIDO.FORMAPAGAMENTO = FORMAPAGAMENTO.CODIGO
        LEFT JOIN TMPCANCELADO ON TMPCANCELADO.FORMAPAGAMENTO = FORMAPAGAMENTO.CODIGO
        --LEFT JOIN TMPDEVOLVIDO ON TMPDEVOLVIDO.FORMAPAGAMENTO = FORMAPAGAMENTO.CODIGO
        GROUP BY 1,2) R1
        WHERE ((VALORTOTALFATURADO > 0) OR (VALORTOTALRECEBIDO > 0) OR (VALORTOTALCANCELADO > 0) /*or (VALORTOTALDEVOLVIDO > 0) */ )