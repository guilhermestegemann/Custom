SET TERM ^ ;

CREATE OR ALTER trigger pedido_bu_wmsdelete for pedido
active before update position 10000
AS
begin
     if (new.filial = 1) then begin
     if ((NEW.CANCELADO <> OLD.CANCELADO) AND (NEW.CANCELADO = 'S') AND (NEW.FATURADO = 'N') AND (OLD.FATURADO = 'N')) then BEGIN
        INSERT INTO LOG_WMS VALUES (NEW.NUMERO, 'VIEW_WMS_PEDIDO', 'NUMERO', 'D', null, NULL, null);
     END
     end
end^

SET TERM ; ^


SET TERM ^ ;

CREATE OR ALTER trigger pedido_bu_wms_can for pedido
active before update position 10001
AS
DECLARE VARIABLE VAR_ROTA VARCHAR(100);
DECLARE VARIABLE VAR_ROMANEIO INTEGER;
DECLARE VARIABLE VAR_PLACA_VEICULO VARCHAR(8);
BEGIN
     IF (NEW.FILIAL = 1 ) THEN BEGIN
     IF ((NEW.CANCELADO <> OLD.CANCELADO) AND (NEW.CANCELADO = 'S') AND (NEW.FATURADO = 'S')) THEN BEGIN
        SELECT FIRST 1 ITEMROMANEIO.ROMANEIO, VEICULO.PLACA
        FROM ITEMROMANEIO
        INNER JOIN ROMANEIO ON ROMANEIO.CODIGO = ITEMROMANEIO.ROMANEIO AND ROMANEIO.FILIAL =1
        INNER JOIN VEICULO ON VEICULO.CODIGO = ROMANEIO.VEICULO
        WHERE ITEMROMANEIO.NUMERO = NEW.NUMERO
        INTO :VAR_ROMANEIO,  :VAR_PLACA_VEICULO;
        VAR_ROTA = 'R' || :VAR_ROMANEIO || '/' || :VAR_PLACA_VEICULO;
        INSERT INTO LOG_WMS VALUES ('CAN'||'/'||NEW.NUMERO, 'VIEW_WMS_PEDIDO', 'NUMERO', 'C', NULL, :VAR_ROTA, NULL);
     END
     END
END^

SET TERM ; ^


CREATE OR ALTER VIEW VIEW_WMS_PEDIDO(
    NUMERO,
    CLIENTE,
    DATA,
    OBSERVACAO)
AS
SELECT CASE WHEN ((PEDIDO.CANCELADO = 'S') OR (PEDIDO.TOTALDEVOLVIDO > 0)) THEN 'CAN'||'/'||PEDIDO.NUMERO ELSE PEDIDO.NUMERO END AS NUMERO
, CAST(SUBSTRING(CLIFOR.NOME FROM 1 FOR 50) AS VARCHAR(50)),
PEDIDO.EMISSAO,
CAST(SUBSTRING(PEDIDO.OBS FROM 1 FOR 200) AS VARCHAR (200))
FROM PEDIDO
INNER JOIN CLIFOR ON CLIFOR.CODIGO = PEDIDO.CLIFOR
AND PEDIDO.EMISSAO > (CURRENT_DATE - 5) AND PEDIDO.FILIAL = 1
;


CREATE OR ALTER VIEW VIEW_WMS_ITEMPEDIDO(
    NUMERO,
    PRODUTO,
    QUANTIDADE)
AS
SELECT
CASE WHEN ((PEDIDO.CANCELADO = 'S') or (ITEMPEDIDO.qtdedevolvido > 0)) THEN 'CAN'||'/'||PEDIDO.NUMERO ELSE CAST('PE'||ITEMPEDIDO.NUMERO AS VARCHAR(30)) END AS NUMERO
, ITEMPEDIDO.PRODUTO
, CASE WHEN ITEMPEDIDO.QTDEDEVOLVIDO > 0 THEN CAST(ITEMPEDIDO.QTDEDEVOLVIDO AS NUMERIC(15,4)) ELSE CAST(ITEMPEDIDO.QTDE AS NUMERIC(15,4)) END AS QUANTIDADE
FROM ITEMPEDIDO
INNER JOIN PEDIDO ON PEDIDO.NUMERO = ITEMPEDIDO.NUMERO AND PEDIDO.FILIAL = ITEMPEDIDO.FILIAL AND PEDIDO.EMISSAO > (CURRENT_DATE - 5)
AND ITEMPEDIDO.FILIAL = 1
;


SET TERM ^ ;

CREATE OR ALTER trigger pedido_bu_wms_dev for pedido
active before update position 10002
AS
DECLARE VARIABLE VAR_ROTA VARCHAR(100);
DECLARE VARIABLE VAR_ROMANEIO INTEGER;
DECLARE VARIABLE VAR_PLACA_VEICULO VARCHAR(8);
BEGIN
     IF (NEW.FILIAL = 1 ) THEN BEGIN
     IF ((NEW.CANCELADO = 'N') AND (OLD.CANCELADO = 'N') AND (NEW.FATURADO = 'S') AND (OLD.FATURADO = 'S') AND (NEW.TOTALDEVOLVIDO <> OLD.TOTALDEVOLVIDO) AND (NEW.TOTALDEVOLVIDO > 0)) THEN BEGIN
        SELECT FIRST 1 ITEMROMANEIO.ROMANEIO, VEICULO.PLACA
        FROM ITEMROMANEIO
        INNER JOIN ROMANEIO ON ROMANEIO.CODIGO = ITEMROMANEIO.ROMANEIO AND ROMANEIO.FILIAL =1
        INNER JOIN VEICULO ON VEICULO.CODIGO = ROMANEIO.VEICULO
        WHERE ITEMROMANEIO.NUMERO = NEW.NUMERO
        INTO :VAR_ROMANEIO,  :VAR_PLACA_VEICULO;
        VAR_ROTA = 'R' || :VAR_ROMANEIO || '/' || :VAR_PLACA_VEICULO;
        INSERT INTO LOG_WMS VALUES ('CAN'||'/'||NEW.NUMERO, 'VIEW_WMS_PEDIDO', 'NUMERO', 'C', NULL, :VAR_ROTA, NULL);
     END
     END
END^

SET TERM ; ^


