CREATE TABLE REGIAO (
    ID DOM_ID,
    EMPRESA DOM_ID,
    CODIGO DOM_INT_NN,
    NOME DOM_STR_60_NN);

ALTER TABLE REGIAO
ADD CONSTRAINT PK_REGIAO
PRIMARY KEY (ID);

ALTER TABLE REGIAO
ADD CONSTRAINT FK_REGIAO_EMPRESA
FOREIGN KEY (EMPRESA)
REFERENCES EMPRESA(ID)
ON DELETE CASCADE
ON UPDATE CASCADE;

ALTER TABLE REGIAO
ADD CONSTRAINT UNQ_REGIAO
UNIQUE (EMPRESA,CODIGO);

CREATE SEQUENCE GEN_REGIAO_ID;

SET TERM ^ ;

CREATE OR ALTER trigger tri_regiao_bi for regiao
active before insert position 0
as
begin
  if (new.id is null) then
    new.id = gen_id(gen_regiao_id,1);
end^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER procedure set_bi_regiao (
    distribuidor dom_str_18_nn,
    codigo dom_int_nn,
    nome dom_str_60_nn)
returns (
    id dom_id)
as
declare variable iddistribuidor dom_id_isn;
declare variable idempresa dom_id_isn;
BEGIN
    SELECT ID FROM GET_DISTRIBUIDOR(:DISTRIBUIDOR) INTO :IDDISTRIBUIDOR;
    IF (:IDDISTRIBUIDOR IS NULL) THEN
        EXCEPTION EXCEPTION_DISTRIBUIDORINVALIDO;

    SELECT DISTRIBUIDOR.EMPRESA FROM DISTRIBUIDOR
    WHERE DISTRIBUIDOR.ID = :IDDISTRIBUIDOR
    INTO :IDEMPRESA;

    UPDATE OR INSERT INTO REGIAO(REGIAO.ID, REGIAO.EMPRESA, REGIAO.CODIGO, REGIAO.NOME)
    VALUES (:CODIGO, :IDEMPRESA, :CODIGO, :NOME)
    MATCHING (REGIAO.ID)
    RETURNING REGIAO.ID INTO :ID;

    SUSPEND;
END^

SET TERM ; ^

