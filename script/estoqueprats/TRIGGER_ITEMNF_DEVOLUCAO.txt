SET TERM ^ ;

CREATE OR ALTER trigger trigger_itemnf_devolucao for itemnf
active before update position 0
AS
DECLARE VARIABLE VARDATA DATE;
DECLARE VARIABLE VARQUANTIDADE NUMERIC(8,3);
DECLARE VARIABLE VARPEDIDO INTEGER;
DECLARE VARIABLE VARCONTROLALOTEVALIDADE VARCHAR(1);
DECLARE VARIABLE VARGERARESTOQUE VARCHAR(1);
DECLARE VARIABLE VARGERARESTOQUEIMPROPRIO VARCHAR(1);
DECLARE VARIABLE VARGERARCONSUMO VARCHAR(1);
/*Validade*/
DECLARE VARIABLE VARVALIDADE DATE;
DECLARE VARIABLE VARLOTE VARCHAR(15);
DECLARE VARIABLE VARQTDE FLOAT;
DECLARE VARIABLE VARFABRICACAO DATE;

DECLARE VARIABLE VARCLIFOR INTEGER;
DECLARE VARIABLE VARINDICADORTIPOESTOQUE INTEGER;
DECLARE VARIABLE VARLOCALORIGEM INTEGER;
DECLARE VARIABLE VARLOCALDESTINO INTEGER;
BEGIN
    IF (NEW.QTDEDEVOLVIDO <> OLD.QTDEDEVOLVIDO) THEN BEGIN
        /*Seleciona dados NF*/
        SELECT NF.EMISSAO, NF.PEDIDO, NF.CLIFOR, TIPOCFOP.INDICADORTIPOESTOQUE, TIPOCFOP.LOCALORIGEM, TIPOCFOP.LOCALDESTINO, TIPOCFOP.GERARCONSUMO
        FROM NF
        INNER JOIN TIPOCFOP ON TIPOCFOP.CODIGO = NF.TIPOCFOP
        WHERE NF.ID = NEW.IDNF
        INTO :VARDATA, :VARPEDIDO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALORIGEM, :VARLOCALDESTINO, :VARGERARCONSUMO;
        /* seleciona dados da NF referenciada */
        SELECT TIPOCFOP.GERARESTOQUE, TIPOCFOP.GERARESTOQUEIMPROPRIO
        FROM NFREFERENCIADA
        INNER JOIN NF
            ON NF.NUMERO = NFREFERENCIADA.NFNUMERO
            AND NF.SERIE = NFREFERENCIADA.NFSERIE
            AND NF.FILIAL = NFREFERENCIADA.NFFILIAL
            AND NF.ORIGEM = NFREFERENCIADA.NFORIGEM
            AND NF.CLIFOR = NFREFERENCIADA.NFCLIFOR
        INNER JOIN TIPOCFOP
            ON TIPOCFOP.CODIGO = NF.TIPOCFOP
        WHERE NFREFERENCIADA.CODIGO = RDB$GET_CONTEXT('USER_TRANSACTION', 'NFREFERENCIADA')
        INTO :VARGERARESTOQUE, :VARGERARESTOQUEIMPROPRIO;

        IF (:VARGERARESTOQUE IS NULL) THEN VARGERARESTOQUE = 'N';
        IF (:VARGERARESTOQUEIMPROPRIO IS NULL) THEN VARGERARESTOQUEIMPROPRIO = 'N';

        IF (:VARGERARCONSUMO = 'S') THEN
        BEGIN
            /*Seleciona dados consumo*/
            SELECT QTDE FROM CONSUMO
            WHERE CONSUMO.FILIAL = NEW.FILIAL
            AND CONSUMO.TIPO = 'NF'
            AND CONSUMO.CLIFOR = NEW.CLIFOR
            AND CONSUMO.DOCUMENTO = NEW.NUMERO
            AND CONSUMO.PRODUTO = NEW.PRODUTO
            --AND CONSUMO.ITEM = NEW.ITEM
            AND CONSUMO.DATA = :VARDATA
            AND CONSUMO.QTDE = NEW.QTDE
            INTO :VARQUANTIDADE;
            IF (:VARQUANTIDADE IS NOT NULL) THEN
            BEGIN
                UPDATE CONSUMO
                    SET CONSUMO.QTDEDEVOLVIDO = NEW.QTDEDEVOLVIDO, CONSUMO.MOTIVODEVOLUCAO = NEW.MOTIVODEVOLUCAO
                WHERE CONSUMO.FILIAL = NEW.FILIAL
                    AND CONSUMO.TIPO = 'NF'
                    AND CONSUMO.DOCUMENTO = NEW.NUMERO
                    AND CONSUMO.CLIFOR = NEW.CLIFOR
                    AND CONSUMO.PRODUTO = NEW.PRODUTO
                    --AND CONSUMO.ITEM = NEW.ITEM
                    AND CONSUMO.QTDE = NEW.QTDE
                    AND CONSUMO.DATA = :VARDATA;
            END
        END

        /*Atualizar Pedido*/
        UPDATE ITEMPEDIDO
            SET ITEMPEDIDO.QTDEDEVOLVIDO = NEW.QTDEDEVOLVIDO
        WHERE ITEMPEDIDO.NUMERO = :VARPEDIDO
            AND ITEMPEDIDO.FILIAL = NEW.FILIAL
            AND ITEMPEDIDO.PRODUTO = NEW.PRODUTO
            AND ITEMPEDIDO.ITEM = NEW.ITEM;
        /*Atualiza NF*/
        UPDATE NF
            SET NF.TOTALDEVOLVIDO = (SELECT SUM(ITEMNF.TOTALDEVOLVIDO) FROM ITEMNF WHERE ITEMNF.idnf = NEW.IDNF)
        WHERE NF.ID = NEW.IDNF;
        /*Atualizar estoque*/

        VARQUANTIDADE = OLD.QTDEDEVOLVIDO - NEW.QTDEDEVOLVIDO;
        IF (VARGERARESTOQUE = 'S') THEN BEGIN
            SELECT ESTOQUE.CONTROLARLOTEVALIDADE FROM ESTOQUE
            WHERE ESTOQUE.FILIAL = NEW.FILIAL AND ESTOQUE.PRODUTO = NEW.PRODUTO
            INTO :VARCONTROLALOTEVALIDADE;

            IF (VARCONTROLALOTEVALIDADE = 'S') THEN BEGIN
                FOR
                    SELECT VALIDADEITEMNF.LOTE, VALIDADEITEMNF.VALIDADE, VALIDADEITEMNF.FABRICACAO, VALIDADEITEMNF.QTDE
                    FROM VALIDADEITEMNF
                    WHERE VALIDADEITEMNF.NUMERO = NEW.NUMERO
                    AND VALIDADEITEMNF.SERIE = NEW.SERIE
                    AND VALIDADEITEMNF.FILIAL = NEW.FILIAL
                    AND VALIDADEITEMNF.ORIGEM = NEW.ORIGEM
                    AND VALIDADEITEMNF.CLIFOR = NEW.CLIFOR
                    AND VALIDADEITEMNF.PRODUTO = NEW.PRODUTO
                    AND VALIDADEITEMNF.ITEM = NEW.ITEM
                    INTO :VARLOTE, :VARVALIDADE, :VARFABRICACAO, :VARQTDE
                DO BEGIN
                    IF (:VARQUANTIDADE <> 0) THEN BEGIN
                        IF (:VARQUANTIDADE < 0) THEN BEGIN
                            IF (:VARQUANTIDADE <= (:VARQTDE * -1)) THEN BEGIN
                                IF (:VARLOCALDESTINO IS NOT NULL) THEN
                                    INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,              MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                             VALUES(NEW.FILIAL,              NEW.PRODUTO,              (:VARQTDE * -1),              :VARVALIDADE,              :VARLOTE,              'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALDESTINO);

                                INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,              MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                         VALUES(NEW.FILIAL,              NEW.PRODUTO,              :VARQTDE,              :VARVALIDADE,              :VARLOTE,              'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALORIGEM);
                                VARQUANTIDADE = :VARQUANTIDADE + :VARQTDE;
                            END ELSE BEGIN
                                IF (:VARLOCALDESTINO IS NOT NULL) THEN
                                    INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,              MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                             VALUES(NEW.FILIAL,              NEW.PRODUTO,              :VARQUANTIDADE,              :VARVALIDADE,              :VARLOTE,              'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALDESTINO);
                                    
                                INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,              MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                         VALUES(NEW.FILIAL,              NEW.PRODUTO,              (:VARQUANTIDADE * -1),              :VARVALIDADE,              :VARLOTE,              'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALORIGEM);
                                VARQUANTIDADE = 0;
                            END
                        END ELSE BEGIN
                            IF (:VARQUANTIDADE >= :VARQTDE) THEN BEGIN
                                IF (:VARLOCALDESTINO IS NOT NULL) THEN
                                    INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,            MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                             VALUES(NEW.FILIAL,              NEW.PRODUTO,              :VARQTDE,              :VARVALIDADE,              :VARLOTE,              'D-NF',         'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALDESTINO);
                                    
                                INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,            MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                         VALUES(NEW.FILIAL,              NEW.PRODUTO,              (:VARQTDE*-1),              :VARVALIDADE,              :VARLOTE,              'D-NF',         'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALORIGEM);
                                VARQUANTIDADE = :VARQUANTIDADE - :VARQTDE;
                            END ELSE BEGIN
                                IF (:VARLOCALDESTINO IS NOT NULL) THEN
                                    INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,              MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                             VALUES(NEW.FILIAL,              NEW.PRODUTO,              :VARQUANTIDADE,              :VARVALIDADE,              :VARLOTE,              'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALDESTINO);
                     
                                INSERT INTO MOVIMENTOESTOQUE(MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.VALIDADE, MOVIMENTOESTOQUE.LOTE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS,              MOVIMENTOESTOQUE.FABRICACAO, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                         VALUES(NEW.FILIAL,              NEW.PRODUTO,              (:VARQUANTIDADE * -1),              :VARVALIDADE,              :VARLOTE,              'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARFABRICACAO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALORIGEM);
                                VARQUANTIDADE = 0;
                            END
                        END
                    END
                END
            END ELSE BEGIN
                IF (:VARLOCALDESTINO IS NOT NULL) THEN
                    INSERT INTO MOVIMENTOESTOQUE (MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                                 VALUES (NEW.FILIAL,              NEW.PRODUTO,              :VARQUANTIDADE, 'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALDESTINO);
                
                INSERT INTO MOVIMENTOESTOQUE (MOVIMENTOESTOQUE.FILIAL, MOVIMENTOESTOQUE.PRODUTO, MOVIMENTOESTOQUE.QTDE, MOVIMENTOESTOQUE.TIPO, MOVIMENTOESTOQUE.OBS, MOVIMENTOESTOQUE.IMPROPRIO, MOVIMENTOESTOQUE.CLIFOR, MOVIMENTOESTOQUE.INDICADORTIPOESTOQUE, MOVIMENTOESTOQUE.LOCAL)
                                             VALUES (NEW.FILIAL,              NEW.PRODUTO,              (:VARQUANTIDADE * -1), 'D-NF',                'DEVOLUCAO NOTA FISCAL:'||NEW.NUMERO, :VARGERARESTOQUEIMPROPRIO, :VARCLIFOR, :VARINDICADORTIPOESTOQUE, :VARLOCALORIGEM);
            END
        END
    END
END^

SET TERM ; ^

