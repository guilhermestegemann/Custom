ALTER TABLE LOCAL
ADD PERMITIRESTOQUENEGATIVO DOMAIN_SNNULL;

UPDATE LOCAL SET PERMITIRESTOQUENEGATIVO = 'N'; COMMIT;

ALTER TABLE LOCAL ALTER COLUMN PERMITIRESTOQUENEGATIVO TYPE DOMAIN_SN;


SET TERM ^ ;

CREATE OR ALTER trigger trigger_armazenamento_negativo for armazenamento
active before insert or update position 2
AS
DECLARE VARIABLE VAR_PERMITIRESTOQUENEGATIVO CHAR(1);
declare variable EXECUTAR CHAR(1);
BEGIN
    EXECUTAR = 'N';
    if ((INSERTING) or ((UPDATING) AND (NEW.QUANTIDADE <> OLD.QUANTIDADE)))   then
        EXECUTAR = 'S';

    IF (:EXECUTAR = 'S') THEN
    BEGIN
        SELECT LOCAL.PERMITIRESTOQUENEGATIVO
        FROM LOCAL
        WHERE LOCAL.CODIGO = NEW.LOCAL
        INTO :VAR_PERMITIRESTOQUENEGATIVO;
        IF ((:VAR_PERMITIRESTOQUENEGATIVO = 'N') AND (NEW.QUANTIDADE < 0)) THEN
            EXCEPTION EXCEPTION_ESTOQUEINSUFICIENTE'PRODUTO: '||NEW.PRODUTO;

    END
END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER trigger trigger_armazenamento_zerado for armazenamento
active before update position 0
AS
BEGIN
    IF (NEW.QUANTIDADE <= 0) THEN
        NEW.ZERADO = CURRENT_TIMESTAMP;
    ELSE
        NEW.ZERADO = NULL;
END^

SET TERM ; ^




