SET TERM ^ ;

CREATE OR ALTER trigger trigger_itemnf_calcula_ipi for itemnf
active before insert or update position 40
AS
DECLARE VARIABLE VARCALCULAIPI VARCHAR(1);
DECLARE VARIABLE VARMOVIMENTACAOFISICA VARCHAR(1);
DECLARE VARIABLE VARFATURA VARCHAR(1);
DECLARE VARIABLE VARFRETECOMPORBASEIPI VARCHAR(1);
BEGIN
    IF ((NEW.RECALCULAR = 'S') AND (NEW.ORIGEM = 'P')) THEN BEGIN
        SELECT TIPOCFOP.CALCULAIPI, TIPOCFOP.MOVIMENTACAOFISICA, TIPOCFOP.FATURA, TIPOCFOP.FRETECOMPORBASEIPI
        FROM CFOP
        INNER JOIN TIPOCFOP ON TIPOCFOP.CODIGO = CFOP.TIPOCFOP
        WHERE CFOP.CODIGO = NEW.CFOP
        INTO :VARCALCULAIPI, :VARMOVIMENTACAOFISICA, :VARFATURA, :VARFRETECOMPORBASEIPI;
        IF (VARCALCULAIPI = 'S') THEN BEGIN
            SELECT CSTIPI, BASEIPI, PERCIPI, VALORIPI, VALORISENTOIPI, VALORPAUTAIPI
            FROM PROCEDURE_CALCULAR_IPI(:VARFATURA, NEW.PRODUTO, NEW.FILIAL, NEW.QTDE, NEW.TOTAL, :VARFRETECOMPORBASEIPI, NEW.VALORFRETE, NEW.VALOROUTRO)
            INTO NEW.CSTIPI, NEW.BASEIPI, NEW.PERCIPI, NEW.VALORIPI, NEW.VALORISENTOIPI, NEW.VALORPAUTAIPI;

        END ELSE BEGIN
            SELECT
                CASE WHEN (:VARFATURA = 'S') THEN TRIBUTACAOIPI.CSTISENTA ELSE TRIBUTACAOIPI.CSTENTRADAISENTA END,
                TRIBUTACAOIPI.ENQUADRAMENTOLEGALISENTA
            FROM ESTOQUE
            INNER JOIN TRIBUTACAOIPI ON TRIBUTACAOIPI.CODIGO = ESTOQUE.TRIBUTACAOIPI
            INNER JOIN FILIAL ON FILIAL.CODIGO = NEW.FILIAL AND FILIAL.INDUSTRIA = 'S'
            WHERE ESTOQUE.PRODUTO = NEW.PRODUTO AND ESTOQUE.FILIAL = NEW.FILIAL
            INTO NEW.CSTIPI, NEW.ENQUADRAMENTOLEGALIPI;
            IF ((:VARMOVIMENTACAOFISICA = 'S') AND (NEW.CSTIPI IS NOT NULL)) THEN BEGIN
                NEW.BASEIPI = 0;
                NEW.PERCIPI = 0;
                NEW.VALORIPI = 0;
                NEW.VALORPAUTAIPI = 0;
                NEW.VALORISENTOIPI = NEW.VALORCONTABIL;
            END
        END
    END
END^

SET TERM ; ^