SET TERM ^ ;

CREATE OR ALTER trigger trigger_itempedido_calculaipi for itempedido
active before insert or update position 40
AS
DECLARE VARIABLE VARCALCULAIPI VARCHAR(1);
DECLARE VARIABLE VAR_CALCULARIMPOSTOPEDIDO VARCHAR(1);
DECLARE VARIABLE VARFATURA VARCHAR(1);
DECLARE VARIABLE VARFRETECOMPORBASEIPI VARCHAR(1);
BEGIN
    IF (NEW.RECALCULAR = 'S') THEN BEGIN
        SELECT FILIAL.CALCULARIMPOSTOPEDIDO FROM FILIAL
        WHERE FILIAL.CODIGO = NEW.FILIAL
        INTO :VAR_CALCULARIMPOSTOPEDIDO;
        IF (:VAR_CALCULARIMPOSTOPEDIDO = 'S') THEN BEGIN
            SELECT TIPOCFOP.CALCULAIPI, TIPOCFOP.FATURA, TIPOCFOP.FRETECOMPORBASEIPI
            FROM PEDIDO
            INNER JOIN TIPOPEDIDO ON TIPOPEDIDO.CODIGO = PEDIDO.TIPOPEDIDO
            INNER JOIN TIPOCFOP ON TIPOCFOP.CODIGO = TIPOPEDIDO.TIPOCFOP
            WHERE PEDIDO.ID = NEW.IDPEDIDO
            INTO :VARCALCULAIPI, :VARFATURA, :VARFRETECOMPORBASEIPI;
            IF (:VARCALCULAIPI = 'S') THEN BEGIN
               SELECT VALORIPI
               FROM PROCEDURE_CALCULAR_IPI(:VARFATURA, NEW.PRODUTO, NEW.FILIAL, NEW.QTDE, NEW.TOTAL, :VARFRETECOMPORBASEIPI, NEW.VALORFRETE, 0)
               INTO NEW.VALORIPI;

            END ELSE BEGIN
                NEW.VALORIPI = 0;
            END
        END ELSE BEGIN
            NEW.VALORIPI = 0;
        END
    END
END^

SET TERM ; ^