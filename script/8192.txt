SET TERM ^ ;

CREATE OR ALTER PROCEDURE CUSTOM_GERA_COMISSAO (
    I_VENDEDOR INTEGER,
    I_FILIAL INTEGER)
RETURNS (
    O_DOCUMENTO INTEGER,
    O_CLIFOR INTEGER,
    O_TOTAL NUMERIC(15,2),
    O_COMISSAO NUMERIC(15,4),
    O_VENDEDOR INTEGER)
AS
DECLARE VARIABLE VAR_EMISSAO DATE;
BEGIN
    O_VENDEDOR = :I_VENDEDOR;
    FOR
        SELECT NF.NUMERO, NF.CLIFOR,  NF.VALORLIQUIDOFATURA, NF.EMISSAO
        FROM NF
        INNER JOIN TIPOCFOP ON TIPOCFOP.CODIGO = NF.TIPOCFOP
                           AND TIPOCFOP.FATURA = 'S'
                           AND TIPOCFOP.GERARCOMISSAO = 'S'
        WHERE NF.FILIAL = :I_FILIAL
        AND NF.FUNCIONARIO = :I_VENDEDOR
        AND NF.EMISSAO BETWEEN '01.01.2019' AND '31.01.2019'
        AND NF.CANCELADA = 'N'
        AND NF.DEVOLVIDA = 'N'
        AND NF.IMPRESSA = 'S'
        AND NF.INUTILIZADA = 'N'
        AND NF.DENEGADA = 'N'
        INTO :O_DOCUMENTO, :O_CLIFOR, O_TOTAL, :VAR_EMISSAO
    DO BEGIN
        SELECT SUM(CONSUMO.COMISSAO)
        FROM CONSUMO
        WHERE CONSUMO.FILIAL = :I_FILIAL
        AND CONSUMO.DOCUMENTO = :O_DOCUMENTO
        AND CONSUMO.CLIFOR = :O_CLIFOR
        AND CONSUMO.DATA = :VAR_EMISSAO
        INTO :O_COMISSAO;
        SUSPEND;
    END
END^

SET TERM ; ^

