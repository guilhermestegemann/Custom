ALTER TABLE TIPOPEDIDO
ADD VINCULARROMANEIOAUTOMATICO DOMAIN_SNNULL;

UPDATE TIPOPEDIDO SET VINCULARROMANEIOAUTOMATICO = 'N'; COMMIT;

ALTER TABLE TIPOPEDIDO ALTER COLUMN VINCULARROMANEIOAUTOMATICO TYPE DOMAIN_SN;

SET TERM ^ ;

CREATE OR ALTER trigger trigger_pedido_prontaentrega for pedido
active after insert position 0
AS
DECLARE VARIABLE TIPOPRONTAENTREGA DOMAIN_SN;
DECLARE VARIABLE ROMANEIOVENDA DOMAIN_INTEIRO;
DECLARE VARIABLE VINCULARROMANEIOAUTOMATICO DOMAIN_SN;
BEGIN
    SELECT TIPOPEDIDO.PRONTAENTREGA, TIPOPEDIDO.VINCULARROMANEIOAUTOMATICO
    FROM TIPOPEDIDO
    WHERE TIPOPEDIDO.CODIGO = NEW.TIPOPEDIDO
    INTO :TIPOPRONTAENTREGA, :VINCULARROMANEIOAUTOMATICO;
    IF ((:TIPOPRONTAENTREGA = 'S') OR (:VINCULARROMANEIOAUTOMATICO = 'S'))  THEN
    BEGIN
        SELECT FIRST 1 PRONTAENTREGA.ROMANEIOVENDA
        FROM PRONTAENTREGA
        WHERE PRONTAENTREGA.FUNCIONARIO = NEW.FUNCIONARIO
        AND PRONTAENTREGA.FINALIZADO = 'N'
        AND PRONTAENTREGA.FILIAL = NEW.FILIAL
        ORDER BY PRONTAENTREGA.CODIGO DESC
        INTO ROMANEIOVENDA;
        IF (:ROMANEIOVENDA IS NOT NULL) THEN
            INSERT INTO ITEMROMANEIO (ROMANEIO, NUMERO, ITEM, TIPO, CONFERIDO, BAIXADO)
                  VALUES (:ROMANEIOVENDA, NEW.NUMERO, 0, 'P', 'N', 'N');
    END
END^

SET TERM ; ^

