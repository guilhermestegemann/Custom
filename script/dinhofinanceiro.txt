SET TERM ^ ;

CREATE OR ALTER trigger custom_financeiro_ocorrencia for financeiro
active before update position 150
AS
DECLARE VARIABLE VARFUNCIONARIO INTEGER;
DECLARE VARIABLE VARNUMEROREGISTRO INTEGER;
DECLARE VARIABLE VARCOMPLEMENTO VARCHAR(100);
DECLARE VARIABLE VAROLDVCTO VARCHAR(10);
DECLARE VARIABLE VARNEWVCTO VARCHAR(10);
BEGIN
    IF ((NEW.DOCUMENTO <> OLD.DOCUMENTO) OR (NEW.VALOR <> OLD.VALOR) OR (NEW.DATAVCTO <> OLD.DATAVCTO)) THEN
    BEGIN
        VARFUNCIONARIO = RDB$GET_CONTEXT('USER_SESSION', 'USUARIO');
        IF (NEW.DOCUMENTO <> OLD.DOCUMENTO) THEN
        BEGIN
            SELECT COALESCE(MAX(NUMEROREGISTRO),0)+1
            FROM OCORRENCIAFINANCEIRO
            WHERE (FILIAL = NEW.FILIAL) AND (CLIFOR = NEW.CLIFOR) AND (ORDEM = NEW.ORDEM) AND (DATAEMISSAO = NEW.DATAEMISSAO)
            INTO :VARNUMEROREGISTRO;
            VARCOMPLEMENTO = 'Usuário: '||:VARFUNCIONARIO||'. '||'Alterado Documento de: '||OLD.DOCUMENTO||' para: '||NEW.DOCUMENTO||'.';
            INSERT INTO OCORRENCIAFINANCEIRO (FILIAL, CLIFOR, ORDEM, DATAEMISSAO, NUMEROREGISTRO, OCORRENCIA, COMPLEMENTO, DATA)
                                      VALUES (NEW.FILIAL, NEW.CLIFOR, NEW.ORDEM, NEW.DATAEMISSAO, :VARNUMEROREGISTRO, 'A', :VARCOMPLEMENTO, CURRENT_DATE);
        END
        IF (NEW.VALOR <> OLD.VALOR) THEN
        BEGIN
            SELECT COALESCE(MAX(NUMEROREGISTRO),0)+1
            FROM OCORRENCIAFINANCEIRO
            WHERE (FILIAL = NEW.FILIAL) AND (CLIFOR = NEW.CLIFOR) AND (ORDEM = NEW.ORDEM) AND (DATAEMISSAO = NEW.DATAEMISSAO)
            INTO :VARNUMEROREGISTRO;
            VARCOMPLEMENTO = 'Usuário: '||:VARFUNCIONARIO||'. '||'Alterado Valor de: '||OLD.VALOR||' para: '||NEW.VALOR||'.';
            INSERT INTO OCORRENCIAFINANCEIRO (FILIAL, CLIFOR, ORDEM, DATAEMISSAO, NUMEROREGISTRO, OCORRENCIA, COMPLEMENTO, DATA)
                                      VALUES (NEW.FILIAL, NEW.CLIFOR, NEW.ORDEM, NEW.DATAEMISSAO, :VARNUMEROREGISTRO, 'A', :VARCOMPLEMENTO, CURRENT_DATE);
        END
        IF (NEW.DATAVCTO <> OLD.DATAVCTO) THEN
        BEGIN
            VAROLDVCTO = EXTRACT(DAY FROM OLD.DATAVCTO)||'/'||EXTRACT(MONTH FROM OLD.DATAVCTO)||'/'||EXTRACT(YEAR FROM OLD.DATAVCTO);
            VARNEWVCTO = EXTRACT(DAY FROM NEW.DATAVCTO)||'/'||EXTRACT(MONTH FROM NEW.DATAVCTO)||'/'||EXTRACT(YEAR FROM NEW.DATAVCTO);
            SELECT COALESCE(MAX(NUMEROREGISTRO),0)+1
            FROM OCORRENCIAFINANCEIRO
            WHERE (FILIAL = NEW.FILIAL) AND (CLIFOR = NEW.CLIFOR) AND (ORDEM = NEW.ORDEM) AND (DATAEMISSAO = NEW.DATAEMISSAO)
            INTO :VARNUMEROREGISTRO;
            VARCOMPLEMENTO = 'Usuário: '||:VARFUNCIONARIO||'. '||'Alterado Vencimento de: '||:VAROLDVCTO||' para: '||:VARNEWVCTO||'.';
            INSERT INTO OCORRENCIAFINANCEIRO (FILIAL, CLIFOR, ORDEM, DATAEMISSAO, NUMEROREGISTRO, OCORRENCIA, COMPLEMENTO, DATA)
                                      VALUES (NEW.FILIAL, NEW.CLIFOR, NEW.ORDEM, NEW.DATAEMISSAO, :VARNUMEROREGISTRO, 'A', :VARCOMPLEMENTO, CURRENT_DATE);
        END
    END
END^

SET TERM ; ^

