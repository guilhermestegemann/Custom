CREATE TABLE METACIDADEVENDEDOR (
    ID DOM_ID,
    META DOM_ID,
    CIDADE DOM_ID,
    VENDEDOR DOM_ID,
    VALOR DOM_NUM_2D_NN,
    QUANTIDADE DOM_NUM_3D_NN,
    PESOBRUTO DOM_NUM_3D_NN,
    VOLUME DOM_INT_NN,
    POSITIVACAO DOM_INT_NN);

CREATE SEQUENCE GEN_METACIDADEVENDEDOR_ID;

SET TERM ^ ;

CREATE TRIGGER TRI_METACIDADEVENDEDOR_BI FOR METACIDADEVENDEDOR
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.ID IS NULL) THEN
    NEW.ID = GEN_ID(GEN_METACIDADEVENDEDOR_ID,1);
END^

SET TERM ; ^

ALTER TABLE METACIDADEVENDEDOR
ADD CONSTRAINT PK_METACIDADEVENDEDOR
PRIMARY KEY (ID);

ALTER TABLE METACIDADEVENDEDOR
ADD CONSTRAINT FK_METACIDADEVENDEDOR_META
FOREIGN KEY (META)
REFERENCES META(ID);

ALTER TABLE METACIDADEVENDEDOR
ADD CONSTRAINT FK_METACIDADEVENDEDOR_CIDADE
FOREIGN KEY (CIDADE)
REFERENCES CIDADE(ID);

ALTER TABLE METACIDADEVENDEDOR
ADD CONSTRAINT FK_METACIDADEVENDEDOR_VEND
FOREIGN KEY (VENDEDOR)
REFERENCES VENDEDOR(ID);

ALTER TABLE METACIDADEVENDEDOR
ADD CONSTRAINT UNQ_METACIDADEVENDEDOR
UNIQUE (META,CIDADE,VENDEDOR);

SET TERM ^ ;

CREATE OR ALTER procedure set_bi_metacidadevendedor (
    distribuidor dom_str_18_nn,
    meta dom_id,
    vendedor dom_str_18_nn,
    cidade dom_str_07,
    valor dom_num_2d_nn,
    quantidade dom_num_3d_nn,
    pesobruto dom_num_3d_nn,
    volume dom_int_nn,
    positivacao dom_int_nn)
returns (
    id dom_id)
as
declare variable iddistribuidor dom_id_isn;
declare variable idcidade dom_id_isn;
declare variable idvendedor dom_id_isn;
declare variable idmeta dom_id_isn;
BEGIN
    SELECT ID FROM GET_DISTRIBUIDOR(:DISTRIBUIDOR) INTO :IDDISTRIBUIDOR;
    IF (:IDDISTRIBUIDOR IS NULL) THEN
        EXCEPTION EXCEPTION_DISTRIBUIDORINVALIDO;

    SELECT ID FROM GET_CIDADE(:CIDADE) INTO :IDCIDADE;
    IF (:IDCIDADE IS NULL) THEN
        EXCEPTION EXCEPTION_CIDADEINVALIDA;

    SELECT ID FROM GET_VENDEDOR(:IDDISTRIBUIDOR, :VENDEDOR) INTO :IDVENDEDOR;
    IF (:IDVENDEDOR IS NULL) THEN
        EXCEPTION EXCEPTION_VENDEDORINVALIDO;

    SELECT ID FROM GET_META(:IDDISTRIBUIDOR, :META) INTO :IDMETA;
    IF (:IDMETA IS NULL) THEN
        EXCEPTION EXCEPTION_METAINVALIDA;

    UPDATE OR INSERT INTO METACIDADEVENDEDOR(META, CIDADE, VENDEDOR, VALOR, QUANTIDADE, PESOBRUTO, VOLUME, POSITIVACAO)
    VALUES (:IDMETA, :IDCIDADE, :IDVENDEDOR,  :VALOR, :QUANTIDADE, :PESOBRUTO, :VOLUME, :POSITIVACAO)
    MATCHING (META, CIDADE, VENDEDOR)
    RETURNING ID INTO :ID;

    SUSPEND;
END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER procedure del_bi_metacidadevendedor (
    meta dom_id_isn,
    distribuidor dom_str_18_nn,
    vendedor dom_str_18_nn,
    cidade dom_str_07)
as
declare variable iddistribuidor dom_id_isn;
declare variable idcidade dom_id_isn;
declare variable idvendedor dom_id_isn;
declare variable idmeta dom_id_isn;
BEGIN
    SELECT ID FROM GET_DISTRIBUIDOR(:DISTRIBUIDOR) INTO :IDDISTRIBUIDOR;
    IF (:IDDISTRIBUIDOR IS NULL) THEN
        EXCEPTION EXCEPTION_DISTRIBUIDORINVALIDO;

    SELECT ID FROM GET_CIDADE(:CIDADE) INTO :IDCIDADE;
    IF (:IDCIDADE IS NULL) THEN
        EXCEPTION EXCEPTION_CIDADEINVALIDA;

    SELECT ID FROM GET_VENDEDOR(:IDDISTRIBUIDOR, :VENDEDOR) INTO :IDVENDEDOR;
    IF (:IDVENDEDOR IS NULL) THEN
        EXCEPTION EXCEPTION_VENDEDORINVALIDO;

    SELECT ID FROM GET_META(:IDDISTRIBUIDOR, :META) INTO :IDMETA;
    IF (:IDMETA IS NULL) THEN
        EXCEPTION EXCEPTION_METAINVALIDA;

    DELETE FROM METACIDADEVENDEDOR
    WHERE METACIDADEVENDEDOR.META = :IDMETA
    AND METACIDADEVENDEDOR.CIDADE = :IDCIDADE
    AND METACIDADEVENDEDOR.VENDEDOR = :IDVENDEDOR;
END^

SET TERM ; ^

