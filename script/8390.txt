SET TERM ^ ;

CREATE OR ALTER PROCEDURE PROCEDURE_CALCULAR_IPI (
    fatura domain_varchar01,
    produto domain_inteiro,
    filial domain_inteiro,
    qtde domain_valor3d,
    valorcontabil domain_valor2d,
    fretecomporbaseipi varchar(1),
    valorfrete domain_valor2d,
    valoroutro domain_valor2d)
returns (
    baseipi domain_valor2d,
    percipi domain_valor4d,
    valoripi domain_valor2d,
    valorisentoipi domain_valor2d,
    valorpautaipi domain_valor2d,
    cstipi domain_varchar02)
as
declare variable varvalorpautaipi domain_valor2d;
declare variable varbaseipi domain_valor2d;
declare variable varindustria varchar(1);
BEGIN
  VALORIPI = 0;
  SELECT
     CASE WHEN (:FATURA = 'S') THEN TRIBUTACAOIPI.CST ELSE TRIBUTACAOIPI.CSTENTRADA END,
     CASE WHEN (:FATURA = 'S') THEN TRIBUTACAOIPI.PERCIPI ELSE TRIBUTACAOIPI.PERCIPIENTRADA END,
     CASE WHEN (:FATURA = 'S') THEN TRIBUTACAOIPI.BASEIPI ELSE TRIBUTACAOIPI.BASEIPIENTRADA END,
     ESTOQUE.VALORPAUTAIPI
  FROM ESTOQUE
  INNER JOIN TRIBUTACAOIPI ON TRIBUTACAOIPI.CODIGO = ESTOQUE.TRIBUTACAOIPI
  WHERE ESTOQUE.PRODUTO = :PRODUTO AND ESTOQUE.FILIAL = :FILIAL
  INTO :CSTIPI,  :PERCIPI, :VARBASEIPI, VARVALORPAUTAIPI;
  SELECT FILIAL.INDUSTRIA FROM FILIAL
  WHERE FILIAL.CODIGO = :FILIAL
  INTO :VARINDUSTRIA;

     IF (:PERCIPI IS NULL) THEN
         PERCIPI = 0;
     PERCIPI = :PERCIPI;
     IF (VARVALORPAUTAIPI IS NULL) THEN
         VALORPAUTAIPI = 0;
     IF (VARVALORPAUTAIPI = 0) THEN BEGIN
         IF (FRETECOMPORBASEIPI = 'S' AND :VARINDUSTRIA = 'S') THEN BEGIN
             BASEIPI = (:VALORCONTABIL + VALORFRETE + VALOROUTRO) * (:VARBASEIPI / 100.0);
         END ELSE
             BASEIPI = :VALORCONTABIL * (:VARBASEIPI / 100.0);
         VALORIPI = :BASEIPI * (:PERCIPI / 100.0);
         VALORISENTOIPI = :VALORCONTABIL - :BASEIPI;
     END ELSE BEGIN
         VALORISENTOIPI = 0;
         PERCIPI = 0;
         BASEIPI = 0;
         VALORIPI = VARVALORPAUTAIPI * :QTDE;
     END
  SUSPEND;
END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER trigger trigger_itemnf_calcula_ipi for itemnf
active before insert or update position 40
AS
DECLARE VARIABLE VARCALCULAIPI VARCHAR(1);
DECLARE VARIABLE VARMOVIMENTACAOFISICA VARCHAR(1);
DECLARE VARIABLE VARFATURA VARCHAR(1);
DECLARE VARIABLE VARFRETECOMPORBASEIPI VARCHAR(1);
BEGIN
    IF ((NEW.RECALCULAR = 'S') AND (NEW.ORIGEM = 'P')) THEN BEGIN
        SELECT TIPOCFOP.CALCULAIPI, TIPOCFOP.MOVIMENTACAOFISICA, TIPOCFOP.FATURA, TIPOCFOP.FRETECOMPORBASEIPI
        FROM CFOP
        INNER JOIN TIPOCFOP ON TIPOCFOP.CODIGO = CFOP.TIPOCFOP
        WHERE CFOP.CODIGO = NEW.CFOP
        INTO :VARCALCULAIPI, :VARMOVIMENTACAOFISICA, :VARFATURA, :VARFRETECOMPORBASEIPI;
        IF (VARCALCULAIPI = 'S') THEN BEGIN
            SELECT CSTIPI, BASEIPI, PERCIPI, VALORIPI, VALORISENTOIPI, VALORPAUTAIPI
            FROM PROCEDURE_CALCULAR_IPI(:VARFATURA, NEW.PRODUTO, NEW.FILIAL, NEW.QTDE, NEW.TOTAL, :VARFRETECOMPORBASEIPI, NEW.VALORFRETE, NEW.VALOROUTRO)
            INTO NEW.CSTIPI, NEW.BASEIPI, NEW.PERCIPI, NEW.VALORIPI, NEW.VALORISENTOIPI, NEW.VALORPAUTAIPI;

        END ELSE BEGIN
            SELECT
                CASE WHEN (:VARFATURA = 'S') THEN TRIBUTACAOIPI.CSTISENTA ELSE TRIBUTACAOIPI.CSTENTRADAISENTA END,
                TRIBUTACAOIPI.ENQUADRAMENTOLEGALISENTA
            FROM ESTOQUE
            INNER JOIN TRIBUTACAOIPI ON TRIBUTACAOIPI.CODIGO = ESTOQUE.TRIBUTACAOIPI
            INNER JOIN FILIAL ON FILIAL.CODIGO = NEW.FILIAL AND FILIAL.INDUSTRIA = 'S'
            WHERE ESTOQUE.PRODUTO = NEW.PRODUTO AND ESTOQUE.FILIAL = NEW.FILIAL
            INTO NEW.CSTIPI, NEW.ENQUADRAMENTOLEGALIPI;
            IF ((:VARMOVIMENTACAOFISICA = 'S') AND (NEW.CSTIPI IS NOT NULL)) THEN BEGIN
                NEW.BASEIPI = 0;
                NEW.PERCIPI = 0;
                NEW.VALORIPI = 0;
                NEW.VALORPAUTAIPI = 0;
                NEW.VALORISENTOIPI = NEW.VALORCONTABIL;
            END
        END
    END
END^

SET TERM ; ^

SET TERM ^ ;

CREATE OR ALTER trigger trigger_itempedido_calculaipi for itempedido
active before insert or update position 40
AS
DECLARE VARIABLE VARCALCULAIPI VARCHAR(1);
DECLARE VARIABLE VAR_CALCULARIMPOSTOPEDIDO VARCHAR(1);
DECLARE VARIABLE VARFATURA VARCHAR(1);
DECLARE VARIABLE VARFRETECOMPORBASEIPI VARCHAR(1);
BEGIN
    IF (NEW.RECALCULAR = 'S') THEN BEGIN
        SELECT FILIAL.CALCULARIMPOSTOPEDIDO FROM FILIAL
        WHERE FILIAL.CODIGO = NEW.FILIAL
        INTO :VAR_CALCULARIMPOSTOPEDIDO;
        IF (:VAR_CALCULARIMPOSTOPEDIDO = 'S') THEN BEGIN
            SELECT TIPOCFOP.CALCULAIPI, TIPOCFOP.FATURA, TIPOCFOP.FRETECOMPORBASEIPI
            FROM PEDIDO
            INNER JOIN TIPOPEDIDO ON TIPOPEDIDO.CODIGO = PEDIDO.TIPOPEDIDO
            INNER JOIN TIPOCFOP ON TIPOCFOP.CODIGO = TIPOPEDIDO.TIPOCFOP
            WHERE PEDIDO.ID = NEW.IDPEDIDO
            INTO :VARCALCULAIPI, :VARFATURA, :VARFRETECOMPORBASEIPI;
            IF (:VARCALCULAIPI = 'S') THEN BEGIN
               SELECT VALORIPI
               FROM PROCEDURE_CALCULAR_IPI(:VARFATURA, NEW.PRODUTO, NEW.FILIAL, NEW.QTDE, NEW.TOTAL, :VARFRETECOMPORBASEIPI, NEW.VALORFRETE, 0)
               INTO NEW.VALORIPI;

            END ELSE BEGIN
                NEW.VALORIPI = 0;
            END
        END ELSE BEGIN
            NEW.VALORIPI = 0;
        END
    END
END^

SET TERM ; ^