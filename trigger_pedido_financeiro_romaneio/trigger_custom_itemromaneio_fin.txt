SET TERM ^ ;

CREATE OR ALTER trigger trigger_custom_itemromaneio_fin for itemromaneio
active after insert or update or delete position 1
AS
DECLARE VARIABLE VAR_ROMANEIO INTEGER;
DECLARE VARIABLE VAR_FILIAL INTEGER;
DECLARE VARIABLE VAR_FILIAL_ROMANEIO INTEGER;
DECLARE VARIABLE VAR_CLIFOR INTEGER;
DECLARE VARIABLE VAR_ORDEM VARCHAR(20);
DECLARE VARIABLE VAR_DATAEMISSAO DATE;
BEGIN
    IF ((INSERTING) OR (UPDATING))  THEN BEGIN
        SELECT ROMANEIO.FILIAL FROM ROMANEIO WHERE ROMANEIO.CODIGO = NEW.ROMANEIO INTO :VAR_FILIAL_ROMANEIO;
        IF (NEW.TIPO = 'P') THEN BEGIN
            FOR
                SELECT FILIAL, CLIFOR, ORDEM, DATAEMISSAO
                FROM (
                    SELECT FINANCEIRO.FILIAL, FINANCEIRO.CLIFOR, FINANCEIRO.ORDEM, FINANCEIRO.DATAEMISSAO
                    FROM FINANCEIRO
                    INNER JOIN PEDIDO ON PEDIDO.NUMERO = FINANCEIRO.DOCUMENTO
                           AND PEDIDO.FILIAL = FINANCEIRO.FILIAL
                           AND PEDIDO.CLIFOR = FINANCEIRO.CLIFOR
                           AND PEDIDO.EMISSAO = FINANCEIRO.DATAEMISSAO
                    WHERE PEDIDO.NUMERO = NEW.NUMERO AND PEDIDO.FILIAL = :VAR_FILIAL_ROMANEIO
                ) GROUP BY FILIAL, CLIFOR, ORDEM, DATAEMISSAO
                INTO :VAR_FILIAL, :VAR_CLIFOR, :VAR_ORDEM, :VAR_DATAEMISSAO
            DO BEGIN
                UPDATE FINANCEIRO SET FINANCEIRO.ROMANEIO = NEW.ROMANEIO
                WHERE FINANCEIRO.FILIAL = :VAR_FILIAL
                AND FINANCEIRO.CLIFOR = :VAR_CLIFOR
                AND FINANCEIRO.ORDEM = :VAR_ORDEM
                AND FINANCEIRO.DATAEMISSAO = :VAR_DATAEMISSAO;
            END
        END
    END
    IF (DELETING) THEN BEGIN
        SELECT ROMANEIO.FILIAL FROM ROMANEIO WHERE ROMANEIO.CODIGO = OLD.ROMANEIO INTO :VAR_FILIAL_ROMANEIO;
        IF (OLD.TIPO = 'P') THEN BEGIN
            FOR
                SELECT FILIAL, CLIFOR, ORDEM, DATAEMISSAO, MAX(ROMANEIO) AS ROMANEIO
                FROM (
                SELECT FINANCEIRO.FILIAL
                     , FINANCEIRO.CLIFOR
                     , FINANCEIRO.ORDEM
                     , FINANCEIRO.DATAEMISSAO
                     , ITEMROMANEIO.ROMANEIO
                FROM FINANCEIRO
                INNER JOIN PEDIDO ON PEDIDO.NUMERO = FINANCEIRO.DOCUMENTO
                                 AND PEDIDO.FILIAL = FINANCEIRO.FILIAL
                                 AND PEDIDO.CLIFOR = FINANCEIRO.CLIFOR
                                 AND PEDIDO.EMISSAO = FINANCEIRO.DATAEMISSAO
                LEFT JOIN ITEMROMANEIO ON ITEMROMANEIO.TIPO = 'P' AND ITEMROMANEIO.NUMERO = PEDIDO.NUMERO
                WHERE (PEDIDO.NUMERO = OLD.NUMERO AND PEDIDO.FILIAL = :VAR_FILIAL_ROMANEIO)
                )
                GROUP BY FILIAL, CLIFOR, ORDEM, DATAEMISSAO
                INTO :VAR_FILIAL, :VAR_CLIFOR, :VAR_ORDEM, :VAR_DATAEMISSAO, :VAR_ROMANEIO
            DO BEGIN
                UPDATE FINANCEIRO SET FINANCEIRO.ROMANEIO = :VAR_ROMANEIO
                WHERE FINANCEIRO.FILIAL = :VAR_FILIAL
                AND FINANCEIRO.CLIFOR = :VAR_CLIFOR
                AND FINANCEIRO.ORDEM = :VAR_ORDEM
                AND FINANCEIRO.DATAEMISSAO = :VAR_DATAEMISSAO;
            END
        END
    END
END^

SET TERM ; ^

